1000 '===    Logic Puzzle Solver
1010 '===
1020 '===     MAIN-PROGRAM   Ver 1.00
1030 '===             '95/3/31-'95/5/6
1040 '
1050 KEY1,"color15,1,1"+CHR$(13)
1060 KEY2,"screen5,2:run"+CHR$(13)
1070 '=== Init ===
1080 DEFINTA-Z:DX=1:DY=1
1090 ONSTRIGGOSUB 3840:STRIG(0)OFF
1100 OPEN"GRP:"AS#1
1110 DIM BL(0),OF(0)            'dummy
1120 DIM X1(0),X2(0),P1(0),P2(0)'dummy
1130 DIM VX(8),VY(8)
1140 FOR I=0 TO 8:READ VX(I),VY(I):NEXT
1150 DEFFNFA!(R,C,MX,AD!)=R*(MX+2)+C+AD!
1160 DEFFNF(R,C,MX,AD!)=VPEEK(R*(MX+2)+C+AD!)
1170 DEFFNWA!(K,P,F1,AD!)=(K-1)*(F1+1)+1+P+AD!
1180 DEFFNW(K,P,F1,AD!)=VPEEK((K-1)*(F1+1)+1+P+AD!)
1190 SETPAGE0,0:COLOR:COLOR1,14,14:CLS
1200 COLOR=(2,4,4,4)
1210 COLOR=(3,3,3,3)
1220 COLOR=(4,6,0,0)
1230 COLOR=(5,0,3,6)
1240 COLOR=(6,5,5,0)
1250 COLOR=(7,0,5,0)
1260 S$=""
1270 FOR I=0 TO 95
1280 READ K$:S$=S$+CHR$(VAL("&H"+K$))
1290 NEXT
1300 SPRITE$(0)=MID$(S$,1,32)
1310 SPRITE$(1)=MID$(S$,33,32)
1320 SPRITE$(2)=MID$(S$,65,32)
1330 S$=""
1340 SETPAGE,2
1350 IF VPEEK(29)<>1 THEN 1400
1360 IF VPEEK(30)<>2 THEN 1400
1370 IF VPEEK(31)<>3 THEN 1400
1380 GOSUB 3420
1390 '=== Menu ===
1400 SETPAGE1,1:CLS
1410 PRESET(95,35):PRINT#1,"1)Solve"
1420 PRESET(95,55):PRINT#1,"2)Fix"
1430 PRESET(95,75):PRINT#1,"3)Save"
1440 PRESET(95,95):PRINT#1,"4)Load"
1450 K$=INPUT$(1)
1460 IF K$="1" THEN 1920
1470 IF K$="2" THEN 1650
1480 IF K$="3" THEN 1590
1490 IF K$<>"4" THEN 1450
1500 '=== Load File ===
1510 GOSUB 3330
1520 IF FL$="" THEN 1400
1530 SETPAGE,2
1540 BLOAD FL$,S
1550 GOSUB 3420
1560 SETPAGE,0:PSET(7,7),14
1570 GOTO 1400
1580 '=== Save File ===
1590 GOSUB 3330
1600 IF FL$="" THEN 1400
1610 SETPAGE,2
1620 BSAVE FL$,0,A4!-1,S
1630 GOTO 1400
1640 '=== Manual Fix ===
1650 SETPAGE,2:VPOKE12,0:VPOKE13,1
1660 GOSUB 3110:SETPAGE,0:DD=1
1670 PUTSPRITE0,(DX*4+3,DY*4+2),4,DD
1680 ST=STICK(0)
1690 LB=STRIG(0):RB=(PEEK(&HFBEB)AND4)\4-1
1700 K$=INKEY$
1710 IF K$=CHR$(27) THEN PUTSPRITE0,(0,217):GOTO 1400
1720 IF RB AND RF=0 THEN DD=(DD+1)MOD3:LF=0
1730 IF LB AND LF=0 THEN GOSUB 1790
1740 DX=(DX-1+VX(ST)+WD)MOD WD +1
1750 DY=(DY-1+VY(ST)+HT)MOD HT +1
1760 RF=RB:IF ST THEN LF=0
1770 GOTO 1670
1780 '--- Left-Button Pushed ---
1790 SETPAGE,2
1800 IF DD>0 THEN 1840
1810 IF FNF(DY,DX,WD,A1!)>253 THEN VPOKE FNFA!(DY,DX,WD,A1!),0
1820 IF FNF(DX,DY,HT,A2!)>253 THEN VPOKE FNFA!(DX,DY,HT,A2!),0
1830 GOTO 1860
1840 VPOKE FNFA!(DY,DX,WD,A1!),253+DD
1850 VPOKE FNFA!(DX,DY,HT,A2!),253+DD
1860 VPOKE A3!+(HT+DX-1)*5+4,0
1870 VPOKE A3!+(DY-1)*5+4,0
1880 SETPAGE,0
1890 GOSUB 3920
1900 RETURN
1910 '=== Prepare to Solve ===
1920 GOSUB 3110:SETPAGE,2
1930 N=VPEEK(11):C=VPEEK(12):RK=VPEEK(13)
1940 IF N<HT THEN MX=WD:MY=HT:M=N+1   :FA!=A1!:BA!=A2!:GOTO 1960
1950 MX=HT:MY=WD:M=N-HT+1:FA!=A2!:BA!=A1!
1960 GOSUB 3950
1970 E=0:FF=0
1980 IF VPEEK(A3!+N*5+4)=1 THEN 2010
1990 ON RK GOSUB 2090,3080',solve_main_C
2000 'E:´×°(ÌÞÚ²¸)Ì×¸Þ/C:Ã²À²¼À¶²½³
2010 GOSUB 3980
2020 IF E>1 THEN 3860
2030 IF FF=0 THEN C=C+1 ELSE C=0:IF RK>1 THEN RK=1:GOTO 2050
2040 N=(N+1)MOD(HT+WD):IF C>=HT+WD THEN GOSUB 3760
2050 VPOKE11,N:VPOKE12,C:VPOKE13,RK
2060 IF E=1 THEN 1400
2070 GOTO 1940
2080 '=== Solve Main A ===
2090 IF VPEEK(A3!+N*5+4)=2 THEN RETURN
2100 NB=VPEEK(A3!+N*5)
2110 IF NB>0 THEN 2180
2120 STRIG(0)ON
2130 FOR X=1 TO MX
2140 IF FNF(M,X,MX,FA!)=254 THEN GOSUB 3600:FF=1
2150 NEXT
2160 STRIG(0)OFF
2170 VPOKE A3!+N*5+4,1:RETURN
2180 F1=VPEEK(A3!+N*5+1)
2190 AD!=VPEEK(A3!+N*5+2)+VPEEK(A3!+N*5+3)*256
2200 BL(0)=0:OF(0)=0
2210 FOR K=1 TO NB
2220 BL(K)=FNW(K,-1,F1,AD!)
2230 OF(K)=OF(K-1)+BL(K-1)+1
2240 NEXT
2250 '--- Decide Position of Block ---
2260 STRIG(0)ON
2270 FOR K=1 TO NB
2280 X1(K)=1
2290 X2(K)=MX
2300 NEXT
2310 FOR X=1 TO MX
2320 D=FNF(M,X,MX,FA!)
2330 IF D=0 OR D>253 THEN 2400
2340 K=1
2350 IF D=K THEN 2380
2360 IF K<NB THEN K=K+1:GOTO 2350
2370 GOTO 2400
2380 IF X2(K)=MX THEN X2(K)=X
2390 X1(K)=X-BL(K)+1
2400 NEXT
2410 OF=1
2420 FOR K=1 TO NB
2430 P=-1:IF OF<X1(K) THEN OF=X1(K)
2440 P=P+1
2450 IF FNW(K,P,F1,AD!)=0 THEN 2440
2460 X=OF(K)+P
2470 IF X<OF THEN VPOKE FNWA!(K,P,F1,AD!),0:GOTO 2440
2480 GOSUB 3530
2490 IF A=0 THEN VPOKE FNWA!(K,P,F1,AD!),0:GOTO 2440
2500 P1(K)=P:OF=X+BL(K)+1
2510 NEXT
2520 OF=MX-BL(NB)+1
2530 FOR K=NB TO 1 STEP -1
2540 P=F1:IF OF>X2(K) THEN OF=X2(K)
2550 P=P-1
2560 IF FNW(K,P,F1,AD!)=0 THEN 2550
2570 X=OF(K)+P
2580 IF X>OF THEN VPOKE FNWA!(K,P,F1,AD!),0:GOTO 2550
2590 GOSUB 3530
2600 IF A=0 THEN VPOKE FNWA!(K,P,F1,AD!),0:GOTO 2550
2610 P2(K)=P:OF=X-BL(K-1)-1
2620 NEXT
2630 FOR K=1 TO NB
2640 IF P2(K)-P1(K)<2 THEN 2720
2650 X=OF(K)+P1(K)+1
2660 FOR P=P1(K)+1 TO P2(K)-1
2670 IF FNW(K,P,F1,AD!)=0 THEN 2700
2680 GOSUB 3530
2690 IF A=0 THEN VPOKE FNWA!(K,P,F1,AD!),0
2700 X=X+1
2710 NEXT
2720 NEXT
2730 '--- Put Dot or Box ---
2740 F=0:CC=0
2750 FOR X=1 TO MX
2760 IF FNF(M,X,MX,FA!)=0    THEN 2920
2770 IF FNF(M,X,MX,FA!)<>254 THEN CC=CC+1:GOTO 3000
2780 '
2790 K=1
2800 P=X-OF(K)-BL(K)+1:IF P<P1(K) THEN P=P1(K)
2810 IF P>P2(K) OR X<OF(K)+P THEN 2840
2820 IF FNW(K,P,F1,AD!) THEN 2870
2830 P=P+1:GOTO 2810
2840 IF K<NB THEN K=K+1:GOTO 2800
2850 GOSUB 3600:F=1:GOTO 3000
2860 '
2870 K=1
2880 IF X>=OF(K)+P2(K) AND X<=OF(K)+P1(K)+BL(K)-1 THEN GOSUB 3670:GOSUB 3720:F=1:GOTO 3000
2890 IF K<NB THEN K=K+1:GOTO 2880
2900 GOTO 3000
2910 '
2920 PP=0
2930 FOR K=1 TO NB
2940 P=P1(K)
2950 IF FNW(K,P,F1,AD!) AND X>=OF(K)+P AND X<=OF(K)+P+BL(K)-1 THEN PP=PP+1:PK=K:GOTO 2970
2960 IF P<P2(K) THEN P=P+1:GOTO 2950
2970 NEXT
2980 IF PP=1 THEN K=PK:GOSUB 3670:F=1
2990 '
3000 NEXT
3010 '--- Situation changed? ---
3020 STRIG(0)OFF
3030 IF E THEN RETURN
3040 IF F THEN FF=1:GOTO 2260
3050 VPOKE A3!+N*5+4,2+(CC=MX)
3060 RETURN
3070 '=== Solve Main B ===
3080 E=2:RETURN
3090 '##### Sub Routines #####
3100 '=== Set Screen ===
3110 SETPAGE0,1
3120 LINE(0,0)-(2,2),1,BF:PSET(7,1),1
3130 FOR I=0 TO 3
3140 LINE(I*5+6,5)-(I*5+8,9),I+4,BF
3150 LINE(I*5+5,6)-(I*5+9,8),I+4,BF
3160 NEXT
3170 SETPAGE,0
3180 IF POINT(7,7)=3 THEN RETURN
3190 CLS
3200 FOR I=0 TO WD:LINE(I*4+7,7)-(I*4+7,HT*4+7),2:NEXT
3210 FOR I=0 TO HT:LINE(7,I*4+7)-(WD*4+7,I*4+7),2:NEXT
3220 FOR I=0 TO WD STEP 5:LINE(I*4+7,7)-(I*4+7,HT*4+7),3:NEXT
3230 FOR I=0 TO HT STEP 5:LINE(7,I*4+7)-(WD*4+7,I*4+7),3:NEXT
3240 SETPAGE,2
3250 FOR J=1 TO HT
3260 AD!=FNFA!(J,0,WD,A1!)
3270 FOR I=1 TO WD
3280 DD=VPEEK(AD!+I):DD=(DD\254)+(DD\255)
3290 COPY(DD*3,0)-(DD*3+2,2),1 TO (I*4+4,J*4+4),0
3300 NEXT:NEXT
3310 RETURN
3320 '=== Input Filename ===
3330 PRESET(50,150):PRINT#1,"Filename:"
3340 FL$=""
3350 PRESET(125,150):PRINT#1,FL$+" "
3360 K$=INPUT$(1)
3370 IF K$=CHR$(13) THEN RETURN
3380 IF K$=CHR$(8) AND FL$<>"" THEN FL$=LEFT$(FL$,LEN(FL$)-1):GOTO 3350
3390 IF ASC(K$)>31 AND K$<>CHR$(127) AND LEN(FL$)<12 THEN FL$=FL$+K$
3400 GOTO 3350
3410 '=== Set Variable ===
3420 HT=VPEEK(0):WD=VPEEK(1)
3430 A1!=VPEEK( 2)+VPEEK( 3)*256
3440 A2!=VPEEK( 4)+VPEEK( 5)*256
3450 A3!=VPEEK( 6)+VPEEK( 7)*256
3460 A4!=VPEEK( 8)+VPEEK( 9)*256
3470 BM=VPEEK(10)
3480 ERASE BL,OF,X1,X2,P1,P2
3490 DIM BL(BM),OF(BM)
3500 DIM X1(BM),X2(BM),P1(BM),P2(BM)
3510 RETURN
3520 '=== Block can be here? ===
3530 I=X
3540 IF FNF(M,I,MX,FA!)=255 THEN A=0:RETURN
3550 I=I+1
3560 IF I<X+BL(K) THEN 3540
3570 IF FNF(M,X-1,MX,FA!)<254 OR FNF(M,X+BL(K),MX,FA!)<254 THEN A=0 ELSE A=1
3580 RETURN
3590 '=== Put Dot ===
3600 VPOKE FNFA!(M,X,MX,FA!),255
3610 VPOKE FNFA!(X,M,MY,BA!),255
3620 IF N<HT THEN DX=X:DY=M:VPOKE A3!+(HT+X-1)*5+4,0:GOTO 3640
3630 DX=M:DY=X:VPOKE A3!+(X-1)*5+4,0
3640 DD=2:GOSUB 3920
3650 RETURN
3660 '=== Put Box ===
3670 VPOKE FNFA!(M,X,MX,FA!),K
3680 IF N<HT THEN DX=X:DY=M ELSE DX=M:DY=X
3690 DD=0:GOSUB 3920
3700 RETURN
3710 '=== Put Box to Background ===
3720 VPOKE FNFA!(X,M,MY,BA!),0
3730 IF N<HT THEN VPOKE A3!+(HT+X-1)*5+4,0:RETURN
3740 VPOKE A3!+(X-1)*5+4,0:RETURN
3750 '=== Can't Go ===
3760 C=0:I=0
3770 IF VPEEK(A3!+I*5+4)>1 THEN RK=RK+1:GOTO 3820
3780 IF I<HT+WD-1 THEN I=I+1:GOTO 3770
3790 E=1:FOR I=0 TO 9:BEEP:NEXT
3800 IF INKEY$<>"" THEN 3800
3810 K$=INPUT$(1)
3820 RETURN
3830 '=== Interrupt by Space-key ===
3840 E=1:BEEP:RETURN
3850 '=== Error ===
3860 BEEP:SETPAGE,0
3870 PRESET(95,95):PRINT#1,"Error!"
3880 IF INKEY$<>"" THEN 3880
3890 K$=INPUT$(1)
3900 PSET(7,7),14:GOTO 1400
3910 '=== Draw Character ===
3920 COPY(DD*3,0)-(DD*3+2,2),1 TO (DX*4+4,DY*4+4),0
3930 RETURN
3940 '=== Mark Set ===
3950 IF N<HT THEN COPY(RK*5,5)-(RK*5+4,9),1 TO (2,N*4+7),0:RETURN
3960 COPY(RK*5,5)-(RK*5+4,9),1 TO ((N-HT)*4+7,2),0:RETURN
3970 '=== Mark Reset ===
3980 IF N<HT THEN COPY(0,5)-(4,9),1 TO (2,N*4+7),0:RETURN
3990 COPY(0,5)-(4,9),1 TO ((N-HT)*4+7,2),0:RETURN
4000 '=== TABLE DATA ===
4010 DATA 0,0,0,-1,1,-1,1,0,1,1,0,1,-1,1,-1,0,-1,-1
4020 '=== SPRITE DATA ===
4030 DATA F8,88,88,88,F8,07,07,07
4040 DATA 07,07,07,07,00,00,00,00
4050 DATA 00,00,00,00,00,F0,F0,F0
4060 DATA F0,F0,F0,F0,00,00,00,00
4070 DATA F8,88,88,88,F8,07,04,04
4080 DATA 04,04,04,07,00,00,00,00
4090 DATA 00,00,00,00,00,F0,10,10
4100 DATA 10,10,10,F0,00,00,00,00
4110 DATA F8,88,88,88,F8,07,04,05
4120 DATA 05,05,04,07,00,00,00,00
4130 DATA 00,00,00,00,00,F0,10,D0
4140 DATA D0,D0,10,F0,00,00,00,00
